---
title: "SBD2_loan_sample_09"
author: "xy"
date: '2023'
output: html_document
df_print: paged
---

# Inroduction

>xy



***



## Prepare workplace

### Install libraries

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

libraries = c("readr", "ggplot2", "dlookr", "dplyr", "RColorBrewer", "DescTools", "ROSE", "ggcorrplot", "car", "plotly", "tidyverse", "Boruta", "corrplot", "GGally", "gridExtra")

lapply(libraries, function(x) if (!(x %in% installed.packages())) {
  install.packages(x)
})

lapply(libraries, library, quietly = TRUE, character.only = TRUE)
```

```{r include=FALSE, echo=FALSE}
rm(list=ls())

set.seed(7)
```


### Read data

> We import the csv file "loan_sample_9.csv" and make a copy of it to ensure that we don't mess up the original dataset.

```{r setup_1}
data_loans <- read_csv("loan_sample_9.csv")
data <- data_loans
```
***

## Descriptive analysis 

### Check the data

> In the first step we explore the data. We start by investigating the structure of the data set.
There are 12 numeric and 5 categorical variables in the dataset. But the numeric variable "Status" with its values "1" and "0" looks like a factor and all the characteristic variables also look like factors.

```{r, echo=FALSE}
head(data)
tail(data)
str(data)
```
***

### Data quality issues - Checking for NAs

> We check the presence of NAs in each of the variables included in the dataset.
There are no NAs values in this dataset.

```{r}
knitr::kable(apply(data, 2, function(x) any(is.na(x))))
```
***

### What data types are included in the data set?

> Now we have 12 numeric and 5 character variables.

```{r}
overview <- overview(data)
plot(overview)
```
***

### Transform some variables

> We transform the characteristic variables in factors to count the categories and order them.

```{r}
data$grade = as.factor(data$grade)
data$home_ownership = as.factor(data$home_ownership)
data$verification_status = as.factor(data$verification_status)
data$purpose = as.factor(data$purpose)
data$application_type = as.factor(data$application_type)
data$Status = as.factor(data$Status)

data <- data %>%
  select(order(sapply(., is.factor)),order(sapply(., is.numeric)))
```

```{r}
overview <- overview(data)
plot(overview)
```
***

### Summary of variables

#### Nummeric Variables

> In most numerical variables there is a large gap between the minimum and maximum.
For example, "loan-amnt" (amount of the loan applied for by the borrower) has a minimum of 1,000 and a maximum of 40,000, or "revol_bal" (Total credit revolving balance) from USD 0 to USD 78,762.
> The average interest rate "int_rate" is around 12.63%, with values between 5.31% and 27.49%.
> The annual income "annual_inc" of borrowers varies greatly, with an average of around USD 63,277.
There are outliers with very high annual salaries.
> There are borrowers with a dti of 0, which could indicate low indebtedness.


#### Variable "purpose"

>The Variable "purpose" (category provided by the borrower for the loan request) has many categories. They contain the name of the type of loan, except for one group. This group is labeled as "other" and contains 2,283 values. Most loans are used for debt consolidation and credit cards.


#### Variable "grade"

> The most people are graded between "B" and "C", in the grades "A" or "B" are similar number of people. The variable "grade" assigned loan grade by the financial service provider.


#### Variable "home_ownership"

> The most people are in rent or has a mortgage for there home. 3,982 people are home owner.
14,278 people from 40,000 aren't verified.


#### Variable "verification_status"

> We see that 14,278 people are not verifide from 40,000 people. 16,129 are source verifide.


#### Variable "application_type"

> Only 530 joined via App from 40,000 people in the System.


#### Variable "Status"

> The target variable "Status" is unbalanced, as there are more loans without default (status 0 = 34,794 persons) than with default (status 1 = 5,206).

```{r}
summary(data)
```
***

### Balance of the target variable  

> In the next step, we investigate our target variable "Status". We notice also before in our sample, that we have 5,206 persons which did not default on their loan and we have 34,794 which did default. 

> As we can see in the visualization the data set is highly imbalanced.

```{r}
ggplot(data, aes(x = Status, fill = Status)) +
  geom_bar() +
  ylab("Count") +
  xlab("Status of the loan")
```

```{r}
PercTable(data$Status)
```
***

> In the next step, we carry-out under sampling and visualizate it again. 

```{r}
set.seed(7)
data_original <- data
data_balanced <- ovun.sample(Status ~ ., data=data, method = "under")
data_under <- data.frame(data_balanced[["data"]])
```

```{r, echo=FALSE}
ggplot(data_under, aes(x = Status, fill = Status)) +
  geom_bar() +
  ylab("Count") +
  xlab("Status of the loan")
```


***

> Visualization of the level of the target variable

```{r, echo=FALSE}
corr_data <- cor(data[1:11])
p_value_data <- cor_pmat(data[1:11])
ggcorrplot(corr_data, type = "lower",
           p.mat = p_value_data,
           outline.col = "white",
           ggtheme = ggplot2::theme_gray,
           colors = c("tomato2", "white", "skyblue2"),
           lab = TRUE)
```


***



### Distribution of the numeric variables


```{r fig.width=15, fig.height=5, echo=FALSE}

create_numeric_plots <- function(data, variable) {
  
  # Histogramm
  hist_plot <- ggplot(data, aes(x = !!sym(variable))) +
    geom_histogram(fill = "#00CED1", color = "white", bins = 30) +
    labs(title = paste("Distribution of", variable), x = variable, y = "Frequency") +
    theme_minimal()

  # Boxplot
  box_plot <- ggplot(data, aes(y = !!sym(variable))) +
    geom_boxplot(fill = "#00CED1", color = "black") +
    labs(title = paste("Boxplot of", variable), y = variable) +
    theme_minimal()

  # Kernel Density Plot
  density_plot <- ggplot(data, aes(x = !!sym(variable))) +
    geom_density(fill = "#00CED1", color = "white") +
    labs(title = paste("Kernel Density Plot of", variable), x = variable, y = "Density") +
    theme_minimal()

  # List of Plots
  return(list(hist_plot, box_plot, density_plot))
}


numeric_variables <- c("loan_amnt", "int_rate", "annual_inc", "dti", "open_acc", "revol_bal",
                        "revol_util", "total_acc", "total_rec_int", "tot_cur_bal", "total_rev_hi_lim")


for (variable in numeric_variables) {
  plots <- create_numeric_plots(data, variable)
  grid.arrange(grobs = plots, ncol = 3)
}

```



***


### Cheking for outliers 

> We provide a boxplot of the numeric variables in both the original and under-sampled dataset. 
 
```{r, fig.width=20, fig.height=20, echo=FALSE}
# Simple visualization of the full data 
boxplot(scale(data[,1:11]), use.cols = TRUE)
```



***


```{r}
knitr::kable(diagnose_outlier(data_under), caption = "Diagnose Outlier", digits = 2)
```
***


#### Visualzation with and without the outliers. 

> We note that for the variables "annual_inc" (The self-reported annual income provided by the borrower during registration) the visualization changes considerably and there the median also tends to shift strongly.

```{r, echo=FALSE}
data_under %>%
  plot_outlier(diagnose_outlier(data_under) %>%
                 filter(outliers_ratio >= 0.5) %>%          # dplyr
                 select(variables) %>%
                 unlist())
```



***



#### Dealing with outliers 

> We do winsorizing for dealing with the highest outliers.

```{r}
outlier <- function(x){
    quantiles <- quantile(x, c(.05, .95))
    x[x < quantiles[1]] <- quantiles[1]
    x[x > quantiles[2]] <- quantiles[2]
    x
}

data_new_under <- map_df(data_under[,-c(12:17)], outlier)
cols <- data_under[,c(12:17)]
data_new_under <- cbind(data_new_under, cols)
```

```{r, fig.width=20, fig.height=20}
boxplot(scale(data_new_under[,c(1:11)]), use.cols = TRUE)
```
***


```{r, echo=FALSE}
for (i in 1:length(data_new_under[,-c(12:17)])) {
  print(ggplot(data_new_under, aes(y = data_new_under[,i], color = Status)) + 
          geom_boxplot() + 
          ylab(names(data_new_under[i])) + 
          theme(axis.title.x=element_blank(),
                axis.text.x=element_blank(),
                axis.ticks.x=element_blank()))
}
```


***


```{r, echo=FALSE}
for (i in 1:length(data_new_under[,-c(12:17)])) {
  print(ggplot(data_new_under, 
               aes(x = data_new_under[,i],
                   fill = Status)) +
          geom_density(alpha = 0.2) +
          xlab(names(data_new_under[i])) +
          ylab("Density"))
}

```



***


```{r, echo=FALSE, fig.width=8, fig.height=5}
corr_data_new_under <- cor(data_new_under[,-c(12:17)])
p_value_data_new_under <- cor_pmat(data_new_under[,-c(12:17)])
p1 <- ggcorrplot(corr_data_new_under, type = "lower",
           p.mat = p_value_data_new_under,
           outline.col = "white",
           ggtheme = ggplot2::theme_gray,
           colors = c("tomato2", "white", "skyblue2"),
           lab = TRUE)

ggplotly(p1, tooltip = c("x", "y"))
```



***


```{r, echo=FALSE}
correlations = cor(data_new_under[-c(12:17)])
corrplot(correlations) 
```



***



```{r, fig.width=20, fig.height=20}
ggpairs(data[, c("loan_amnt", "int_rate", "annual_inc", "dti", "total_acc", "total_rec_int", "tot_cur_bal")], 
        aes(color = as.factor(data$Status)))
```



***


### Association between the loan amount requested and the annual income of the borrower

```{r, echo=FALSE}
plot_ly(data, x = ~loan_amnt, y = ~annual_inc, mode = "markers",
                        type = "scatter", marker = list(color = "#00CED1")) %>%
  layout(title = "Scatter Plot of Loan Amount vs. Annual Income",
         xaxis = list(title = "Loan Amount"),
         yaxis = list(title = "Annual Income"))
```























